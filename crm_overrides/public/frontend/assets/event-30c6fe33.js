import{O as te,P as ae,m as h,z as Y,b9 as ne,Y as re,e as B,f as C,c as T,d as V,b as _,w as x,u as k,n as le,aO as N,a3 as S,g as F,C as P,aD as se,t as R,F as j,r as H,H as U,a0 as Q,Q as w,aR as q}from"./index-f67ab40e.js";import{_ as K,r as L}from"./index-2d43ee63.js";import{C as oe,a as ue,b as ie,c as ce,d as fe,e as de,f as me,g as pe}from"./ComboboxViewport-2f4f3fda.js";const ve={class:"flex items-center w-full text-ink-gray-8 [&>div]:w-full"},ge={class:"flex flex-col gap-1 p-1 text-ink-gray-8"},_e={class:"text-base font-medium"},he={class:"text-sm text-ink-gray-5"},ke={__name:"Attendee",props:te({validate:{type:Function,default:null},variant:{type:String,default:"subtle"},size:{type:String,default:"sm"},placeholder:{type:String,default:"Add attendee"},inputClass:{type:String,default:""},errorMessage:{type:Function,default:e=>`${e} is an Invalid value`},fetchContacts:{type:Boolean,default:!0},existingEmails:{type:Array,default:()=>[]}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(e,{expose:n}){const l=e,r=ae(e,"modelValue"),u=h([]),g=h(null),d=h(null),D=h(null),v=h(""),m=h(""),f=h(!1),s=h(null),p=h(null),I=Y(()=>{const t={},a=r.value||[];for(const i of a)i!=null&&i.email&&(t[i.email]=i);return t});function E(t){const a=I.value[t];if(!a)return t;const i=[];return a.reference_doctype&&i.push(a.reference_doctype),a.reference_docname&&i.push(a.reference_docname),i.length?i.join(": "):t}ne(v,t=>{var a;t=t||"",!(m.value===t&&((a=b.value)!=null&&a.length))&&(m.value=t,J(t))},{debounce:300,immediate:!0});const M=re({url:"crm.api.contact.search_emails",method:"POST",cache:[m.value,"Contact"],params:{txt:m.value},transform:t=>{var i;let a=t.map(y=>{let $=y[0],o=y[1],c=y[2];return{label:$||c||o,name:c,value:o}});return(i=l.existingEmails)!=null&&i.length&&(a=a.filter(y=>!l.existingEmails.includes(y.value))),a}}),b=Y(()=>{let t=l.fetchContacts?M.data:[];return!(t!=null&&t.length)&&v.value&&t.push({name:"new",label:v.value,value:v.value}),t||[]}),G=Y(()=>l.fetchContacts?__("No results found"):__("Type an email address to add attendee"));function J(t){l.fetchContacts&&(M.update({params:{txt:t}}),M.reload())}function A(t,a=null){if(!t)return;const i=a||b.value.find(y=>y.value===t)||{name:"new",label:t,value:t};Z(i),d.value||(v.value="",p.value=null,f.value=!1,U(()=>z()))}function W(){v.value&&A(v.value,{name:"new",label:v.value,value:v.value})}function X(t){v.value=t.target.value,f.value=!0}const Z=t=>{if(!t||!t.value)return;d.value=null,D.value=null;const a=Array.isArray(r.value)?r.value.slice():[],i=new Set(a.map(c=>c.email)),$=(t.value||"").split(","),o=$.length>1;for(let c of $){if(c=c.trim(),!c)continue;if(i.has(c)){D.value=__("email already exists");continue}if(l.validate&&!l.validate(c)){d.value=l.errorMessage(c),v.value=c;continue}i.add(c);const O={email:c};t.name&&!o&&(O.reference_docname=t.name),a.push(O)}r.value=a,U(()=>{requestAnimationFrame(()=>{const c=s.value;c&&c.scrollTo({top:c.scrollHeight,behavior:"smooth"})})})},ee=t=>{r.value=(r.value||[]).filter(a=>a.email!==t)};function z(){var t,a;(a=(t=g.value)==null?void 0:t.focus)==null||a.call(t)}return n({setFocus:z}),(t,a)=>{const i=B("FeatherIcon"),y=B("Button"),$=B("ErrorMessage");return C(),T("div",null,[V("div",ve,[_(k(pe),{"model-value":p.value,open:f.value,"onUpdate:open":a[5]||(a[5]=o=>f.value=o),"onUpdate:modelValue":A,"ignore-filter":!0},{default:x(()=>[_(k(oe),{class:le(["flex w-full text-base items-center gap-1 rounded border border-outline-gray-2 bg-surface-white hover:border-outline-gray-3 focus:border-outline-gray-4 focus:ring-0 focus-visible:ring-2 focus-visible:ring-outline-gray-3 px-2 py-1",[e.size==="sm"?"h-7":"h-8 ",e.inputClass]]),onClick:a[2]||(a[2]=o=>f.value=!0)},{default:x(()=>[_(k(ue),{ref_key:"search",ref:g,autocomplete:"off",class:"bg-transparent p-0 outline-none border-0 text-base text-ink-gray-8 h-full placeholder:text-ink-gray-4 w-full focus:outline-none focus:ring-0 focus:border-0",placeholder:e.placeholder,value:v.value,onInput:X,onKeydown:[N(S(W,["prevent"]),["enter"]),a[0]||(a[0]=N(S(o=>f.value=!1,["stop"]),["escape"]))]},null,8,["placeholder","value","onKeydown"]),_(i,{name:"chevron-down",class:"h-4 text-ink-gray-5 cursor-pointer",onClick:a[1]||(a[1]=S(o=>f.value=!f.value,["stop"]))})]),_:1},8,["class"]),_(k(ie),null,{default:x(()=>[_(k(ce),{class:"z-10 mt-1 min-w-48 w-full max-w-md bg-surface-modal overflow-hidden rounded-lg shadow-2xl ring-1 ring-black ring-opacity-5",position:"popper",align:"start",onOpenAutoFocus:a[3]||(a[3]=S(()=>{},["prevent"])),onCloseAutoFocus:a[4]||(a[4]=S(()=>{},["prevent"]))},{default:x(()=>[_(k(fe),{class:"max-h-60 overflow-auto p-1.5"},{default:x(()=>[_(k(de),{class:"flex gap-2 rounded px-2 py-1 text-base text-ink-gray-5"},{default:x(()=>[e.fetchContacts?(C(),F(i,{key:0,name:"search",class:"h-4"})):P("",!0),se(" "+R(G.value),1)]),_:1}),(C(!0),T(j,null,H(b.value,o=>(C(),F(k(me),{key:o.value,value:o.value,class:"text-base leading-none text-ink-gray-7 rounded flex items-center px-2 py-1 relative select-none data-[highlighted]:outline-none data-[highlighted]:bg-surface-gray-3 cursor-pointer",onMousedown:S(c=>A(o.value,o),["prevent"])},{default:x(()=>[_(K,{class:"mr-2",user:o.value,size:"lg"},null,8,["user"]),V("div",ge,[V("div",_e,R(o.label),1),V("div",he,R(o.value),1)])]),_:2},1032,["value","onMousedown"]))),128))]),_:1})]),_:1})]),_:1})]),_:1},8,["model-value","open"])]),r.value.length?(C(),T("div",{key:0,class:"flex flex-col gap-2 mt-2 max-h-[165px] overflow-y-auto",ref_key:"optionsRef",ref:s},[(C(!0),T(j,null,H(r.value,o=>(C(),F(y,{ref_for:!0,ref_key:"emails",ref:u,key:o.email,label:o.email,theme:"gray",class:"rounded-full w-fit",tooltip:E(o.email)},{prefix:x(()=>[_(K,{user:o.email,class:"-ml-1 !size-5.5"},null,8,["user"])]),suffix:x(()=>[_(i,{class:"h-3.5",name:"x",onClick:S(c=>ee(o.email),["stop"])},null,8,["onClick"])]),_:2},1032,["label","tooltip"]))),128)),d.value?(C(),F($,{key:0,class:"mt-2 pl-2",message:d.value},null,8,["message"])):P("",!0)],512)):P("",!0)])}}};function ye(){const e=[];for(let n=0;n<24;n++)for(const l of[0,15,30,45]){const r=String(n).padStart(2,"0"),u=String(l).padStart(2,"0"),g=n>=12?"pm":"am",d=n%12===0?12:n%12;e.push({value:`${r}:${u}`,label:`${d}:${u} ${g}`})}return e}const Se=h(!1),Ee=h(null);function Me(e,n){const{getUser:l}=Q(),r=q({doctype:"Event",cache:["calendar",n],fields:["name","status","subject","description","starts_on","ends_on","all_day","event_type","color","owner","reference_doctype","reference_docname","creation"],filters:{reference_doctype:e,reference_docname:n},auto:!0,orderBy:"creation desc",onSuccess:m=>{console.log(m)}}),u=q({doctype:"Event Participants",fields:["*"],parent:"Event"}),g=Y(()=>{var f;if(!r.data)return[];const m=r.data.map(s=>s.name);return!((f=u.data)!=null&&f.length)||d(m)?(u.update({filters:{parenttype:"Event",parentfield:"event_participants",parent:["in",m]}}),!u.list.loading&&u.reload()):r.data.forEach(s=>{typeof s.owner!="object"&&(s.owner={label:l(s.owner).full_name,image:l(s.owner).user_image,name:s.owner}),s.event_participants=[...u.data.filter(p=>p.parent===s.name)],s.participants=[s.owner,...u.data.filter(p=>p.parent===s.name).map(p=>({label:l(p.email).full_name||p.email,image:l(p.email).user_image||"",name:p.email}))]}),r.data});function d(m){var E,M;const f=(M=(E=u.filters)==null?void 0:E.parent)==null?void 0:M[1];if(m.length&&!L(f,m))return!0;let s=r.setValue.data;if(!s)return!1;let p=s.event_participants.map(b=>b.name),I=u.data.filter(b=>b.parent===s.name).map(b=>b.name);return!L(p,I)}return{eventsResource:r,eventParticipantsResource:u,events:g,startEndTime:(m,f,s=!1,p="h:mm a")=>{const I=w(m),E=w(f);return s?__("All day"):`${I.format(p)} - ${E.format(p)}`},startDate:(m,f="ddd, D MMM YYYY")=>w(m).format(f)}}function $e(e=[]){const n=new Set,l=[];for(const r of e||[])!(r!=null&&r.email)||n.has(r.email)||(n.add(r.email),l.push({email:r.email,reference_doctype:r.reference_doctype||"Contact",reference_docname:r.reference_docname||""}));return l}function be(e){if(e<60)return __("{0} mins",[e]);let n=e/60;return n%1!==0&&n%1!==.5&&(n=n.toFixed(2)),Number.isInteger(n)?n===1?__("1 hr"):__("{0} hrs",[n]):`${n} hrs`}function De(e){const n=ye();if(!e)return n;const l=n.findIndex(d=>d.value>e);if(l===-1)return[];const[r,u]=e.split(":").map(d=>parseInt(d)),g=r*60+u;return n.slice(l).map(d=>{const[D,v]=d.value.split(":").map(s=>parseInt(s)),f=D*60+v-g;return{...d,label:`${d.label} (${be(f)})`}})}function Ie(e){if(!e)return"";const[n,l]=e.split(":").map(g=>parseInt(g));let r=n+1,u=l;return r>=24&&(r=23,u=59),`${String(r).padStart(2,"0")}:${String(u).padStart(2,"0")}`}function Te({fromDate:e,fromTime:n,toTime:l,isFullDay:r}){if(r)return{valid:!0,error:null};if(!n||!l)return{valid:!1,error:__("Start and end time are required")};const u=w(e+" "+n),g=w(e+" "+l);return!u.isValid()||!g.isValid()?{valid:!1,error:__("Invalid start or end time")}:g.diff(u,"minute")<=0?{valid:!1,error:__("End time should be after start time")}:{valid:!0,error:null}}function Ve(e){if(!e)return{};const{getUser:n}=Q();return{id:e.name,title:e.subject,description:e.description,status:e.status,fromDate:w(e.starts_on).format("YYYY-MM-DD"),toDate:w(e.ends_on).format("YYYY-MM-DD"),fromTime:w(e.starts_on).format("HH:mm"),toTime:w(e.ends_on).format("HH:mm"),isFullDay:e.all_day,eventType:e.event_type,color:e.color,referenceDoctype:e.reference_doctype,referenceDocname:e.reference_docname,event_participants:e.event_participants||[],owner:e.owner?{label:n(e.owner).full_name,image:n(e.owner).user_image,value:e.owner}:null}}export{ke as _,Ee as a,De as b,Ie as c,$e as n,Ve as p,Se as s,Me as u,Te as v};
//# sourceMappingURL=event-30c6fe33.js.map
