import{O as te,P as ae,m as h,z as F,b9 as ne,Y as re,e as z,f as C,c as I,d as T,b as _,w as b,u as k,n as le,aO as N,a3 as S,g as V,C as B,aD as se,t as P,F as j,r as H,H as U,a0 as Q,Q as w,aR as q}from"./index-a6920b9f.js";import{_ as K}from"./index-8df5241e.js";import{C as oe,a as ue,b as ie,c as ce,d as fe,e as de,f as me,g as pe}from"./ComboboxViewport-5c5445f5.js";const ve={class:"flex items-center w-full text-ink-gray-8 [&>div]:w-full"},ge={class:"flex flex-col gap-1 p-1 text-ink-gray-8"},_e={class:"text-base font-medium"},he={class:"text-sm text-ink-gray-5"},ke={__name:"Attendee",props:te({validate:{type:Function,default:null},variant:{type:String,default:"subtle"},size:{type:String,default:"sm"},placeholder:{type:String,default:"Add attendee"},inputClass:{type:String,default:""},errorMessage:{type:Function,default:e=>`${e} is an Invalid value`},fetchContacts:{type:Boolean,default:!0},existingEmails:{type:Array,default:()=>[]}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(e,{expose:n}){const l=e,a=ae(e,"modelValue"),s=h([]),g=h(null),d=h(null),D=h(null),v=h(""),m=h(""),f=h(!1),o=h(null),p=h(null),A=F(()=>{const t={},r=a.value||[];for(const i of r)i!=null&&i.email&&(t[i.email]=i);return t});function E(t){const r=A.value[t];if(!r)return t;const i=[];return r.reference_doctype&&i.push(r.reference_doctype),r.reference_docname&&i.push(r.reference_docname),i.length?i.join(": "):t}ne(v,t=>{var r;t=t||"",!(m.value===t&&((r=x.value)!=null&&r.length))&&(m.value=t,J(t))},{debounce:300,immediate:!0});const M=re({url:"crm.api.contact.search_emails",method:"POST",cache:[m.value,"Contact"],params:{txt:m.value},transform:t=>{var i;let r=t.map(y=>{let $=y[0],u=y[1],c=y[2];return{label:$||c||u,name:c,value:u}});return(i=l.existingEmails)!=null&&i.length&&(r=r.filter(y=>!l.existingEmails.includes(y.value))),r}}),x=F(()=>{let t=l.fetchContacts?M.data:[];return!(t!=null&&t.length)&&v.value&&t.push({name:"new",label:v.value,value:v.value}),t||[]}),G=F(()=>l.fetchContacts?__("No results found"):__("Type an email address to add attendee"));function J(t){l.fetchContacts&&(M.update({params:{txt:t}}),M.reload())}function Y(t,r=null){if(!t)return;const i=r||x.value.find(y=>y.value===t)||{name:"new",label:t,value:t};Z(i),d.value||(v.value="",p.value=null,f.value=!1,U(()=>R()))}function W(){v.value&&Y(v.value,{name:"new",label:v.value,value:v.value})}function X(t){v.value=t.target.value,f.value=!0}const Z=t=>{if(!t||!t.value)return;d.value=null,D.value=null;const r=Array.isArray(a.value)?a.value.slice():[],i=new Set(r.map(c=>c.email)),$=(t.value||"").split(","),u=$.length>1;for(let c of $){if(c=c.trim(),!c)continue;if(i.has(c)){D.value=__("email already exists");continue}if(l.validate&&!l.validate(c)){d.value=l.errorMessage(c),v.value=c;continue}i.add(c);const O={email:c};t.name&&!u&&(O.reference_docname=t.name),r.push(O)}a.value=r,U(()=>{requestAnimationFrame(()=>{const c=o.value;c&&c.scrollTo({top:c.scrollHeight,behavior:"smooth"})})})},ee=t=>{a.value=(a.value||[]).filter(r=>r.email!==t)};function R(){var t,r;(r=(t=g.value)==null?void 0:t.focus)==null||r.call(t)}return n({setFocus:R}),(t,r)=>{const i=z("FeatherIcon"),y=z("Button"),$=z("ErrorMessage");return C(),I("div",null,[T("div",ve,[_(k(pe),{"model-value":p.value,open:f.value,"onUpdate:open":r[5]||(r[5]=u=>f.value=u),"onUpdate:modelValue":Y,"ignore-filter":!0},{default:b(()=>[_(k(oe),{class:le(["flex w-full text-base items-center gap-1 rounded border border-outline-gray-2 bg-surface-white hover:border-outline-gray-3 focus:border-outline-gray-4 focus:ring-0 focus-visible:ring-2 focus-visible:ring-outline-gray-3 px-2 py-1",[e.size==="sm"?"h-7":"h-8 ",e.inputClass]]),onClick:r[2]||(r[2]=u=>f.value=!0)},{default:b(()=>[_(k(ue),{ref_key:"search",ref:g,autocomplete:"off",class:"bg-transparent p-0 outline-none border-0 text-base text-ink-gray-8 h-full placeholder:text-ink-gray-4 w-full focus:outline-none focus:ring-0 focus:border-0",placeholder:e.placeholder,value:v.value,onInput:X,onKeydown:[N(S(W,["prevent"]),["enter"]),r[0]||(r[0]=N(S(u=>f.value=!1,["stop"]),["escape"]))]},null,8,["placeholder","value","onKeydown"]),_(i,{name:"chevron-down",class:"h-4 text-ink-gray-5 cursor-pointer",onClick:r[1]||(r[1]=S(u=>f.value=!f.value,["stop"]))})]),_:1},8,["class"]),_(k(ie),null,{default:b(()=>[_(k(ce),{class:"z-10 mt-1 min-w-48 w-full max-w-md bg-surface-modal overflow-hidden rounded-lg shadow-2xl ring-1 ring-black ring-opacity-5",position:"popper",align:"start",onOpenAutoFocus:r[3]||(r[3]=S(()=>{},["prevent"])),onCloseAutoFocus:r[4]||(r[4]=S(()=>{},["prevent"]))},{default:b(()=>[_(k(fe),{class:"max-h-60 overflow-auto p-1.5"},{default:b(()=>[_(k(de),{class:"flex gap-2 rounded px-2 py-1 text-base text-ink-gray-5"},{default:b(()=>[e.fetchContacts?(C(),V(i,{key:0,name:"search",class:"h-4"})):B("",!0),se(" "+P(G.value),1)]),_:1}),(C(!0),I(j,null,H(x.value,u=>(C(),V(k(me),{key:u.value,value:u.value,class:"text-base leading-none text-ink-gray-7 rounded flex items-center px-2 py-1 relative select-none data-[highlighted]:outline-none data-[highlighted]:bg-surface-gray-3 cursor-pointer",onMousedown:S(c=>Y(u.value,u),["prevent"])},{default:b(()=>[_(K,{class:"mr-2",user:u.value,size:"lg"},null,8,["user"]),T("div",ge,[T("div",_e,P(u.label),1),T("div",he,P(u.value),1)])]),_:2},1032,["value","onMousedown"]))),128))]),_:1})]),_:1})]),_:1})]),_:1},8,["model-value","open"])]),a.value.length?(C(),I("div",{key:0,class:"flex flex-col gap-2 mt-2 max-h-[165px] overflow-y-auto",ref_key:"optionsRef",ref:o},[(C(!0),I(j,null,H(a.value,u=>(C(),V(y,{ref_for:!0,ref_key:"emails",ref:s,key:u.email,label:u.email,theme:"gray",class:"rounded-full w-fit",tooltip:E(u.email)},{prefix:b(()=>[_(K,{user:u.email,class:"-ml-1 !size-5.5"},null,8,["user"])]),suffix:b(()=>[_(i,{class:"h-3.5",name:"x",onClick:S(c=>ee(u.email),["stop"])},null,8,["onClick"])]),_:2},1032,["label","tooltip"]))),128)),d.value?(C(),V($,{key:0,class:"mt-2 pl-2",message:d.value},null,8,["message"])):B("",!0)],512)):B("",!0)])}}};function ye(){const e=[];for(let n=0;n<24;n++)for(const l of[0,15,30,45]){const a=String(n).padStart(2,"0"),s=String(l).padStart(2,"0"),g=n>=12?"pm":"am",d=n%12===0?12:n%12;e.push({value:`${a}:${s}`,label:`${d}:${s} ${g}`})}return e}const Se=h(!1),Ee=h(null);function L(e,n){if(e===n)return!0;if(!Array.isArray(e)||!Array.isArray(n)||e.length!==n.length)return!1;if(e.length===0)return!0;const l=new Map;for(const a of e)l.set(a,(l.get(a)||0)+1);for(const a of n){const s=l.get(a);if(!s)return!1;s===1?l.delete(a):l.set(a,s-1)}return l.size===0}function Me(e,n){const{getUser:l}=Q(),a=q({doctype:"Event",cache:["calendar",n],fields:["name","status","subject","description","starts_on","ends_on","all_day","event_type","color","owner","reference_doctype","reference_docname","creation"],filters:{reference_doctype:e,reference_docname:n},auto:!0,orderBy:"creation desc",onSuccess:m=>{console.log(m)}}),s=q({doctype:"Event Participants",fields:["*"],parent:"Event"}),g=F(()=>{var f;if(!a.data)return[];const m=a.data.map(o=>o.name);return!((f=s.data)!=null&&f.length)||d(m)?(s.update({filters:{parenttype:"Event",parentfield:"event_participants",parent:["in",m]}}),!s.list.loading&&s.reload()):a.data.forEach(o=>{typeof o.owner!="object"&&(o.owner={label:l(o.owner).full_name,image:l(o.owner).user_image,name:o.owner}),o.event_participants=[...s.data.filter(p=>p.parent===o.name)],o.participants=[o.owner,...s.data.filter(p=>p.parent===o.name).map(p=>({label:l(p.email).full_name||p.email,image:l(p.email).user_image||"",name:p.email}))]}),a.data});function d(m){var E,M;const f=(M=(E=s.filters)==null?void 0:E.parent)==null?void 0:M[1];if(m.length&&!L(f,m))return!0;let o=a.setValue.data;if(!o)return!1;let p=o.event_participants.map(x=>x.name),A=s.data.filter(x=>x.parent===o.name).map(x=>x.name);return!L(p,A)}return{eventsResource:a,eventParticipantsResource:s,events:g,startEndTime:(m,f,o=!1,p="h:mm a")=>{const A=w(m),E=w(f);return o?__("All day"):`${A.format(p)} - ${E.format(p)}`},startDate:(m,f="ddd, D MMM YYYY")=>w(m).format(f)}}function $e(e=[]){const n=new Set,l=[];for(const a of e||[])!(a!=null&&a.email)||n.has(a.email)||(n.add(a.email),l.push({email:a.email,reference_doctype:a.reference_doctype||"Contact",reference_docname:a.reference_docname||""}));return l}function xe(e){if(e<60)return __("{0} mins",[e]);let n=e/60;return n%1!==0&&n%1!==.5&&(n=n.toFixed(2)),Number.isInteger(n)?n===1?__("1 hr"):__("{0} hrs",[n]):`${n} hrs`}function De(e){const n=ye();if(!e)return n;const l=n.findIndex(d=>d.value>e);if(l===-1)return[];const[a,s]=e.split(":").map(d=>parseInt(d)),g=a*60+s;return n.slice(l).map(d=>{const[D,v]=d.value.split(":").map(o=>parseInt(o)),f=D*60+v-g;return{...d,label:`${d.label} (${xe(f)})`}})}function Ae(e){if(!e)return"";const[n,l]=e.split(":").map(g=>parseInt(g));let a=n+1,s=l;return a>=24&&(a=23,s=59),`${String(a).padStart(2,"0")}:${String(s).padStart(2,"0")}`}function Ie({fromDate:e,fromTime:n,toTime:l,isFullDay:a}){if(a)return{valid:!0,error:null};if(!n||!l)return{valid:!1,error:__("Start and end time are required")};const s=w(e+" "+n),g=w(e+" "+l);return!s.isValid()||!g.isValid()?{valid:!1,error:__("Invalid start or end time")}:g.diff(s,"minute")<=0?{valid:!1,error:__("End time should be after start time")}:{valid:!0,error:null}}function Te(e){if(!e)return{};const{getUser:n}=Q();return{id:e.name,title:e.subject,description:e.description,status:e.status,fromDate:w(e.starts_on).format("YYYY-MM-DD"),toDate:w(e.ends_on).format("YYYY-MM-DD"),fromTime:w(e.starts_on).format("HH:mm"),toTime:w(e.ends_on).format("HH:mm"),isFullDay:e.all_day,eventType:e.event_type,color:e.color,referenceDoctype:e.reference_doctype,referenceDocname:e.reference_docname,event_participants:e.event_participants||[],owner:e.owner?{label:n(e.owner).full_name,image:n(e.owner).user_image,value:e.owner}:null}}export{ke as _,Ee as a,De as b,Ae as c,$e as n,Te as p,Se as s,Me as u,Ie as v};
//# sourceMappingURL=event-2ffbd56c.js.map
