import{O as ge,a0 as _e,P as be,aM as ye,m as f,A as ke,Y as ne,z as pe,a as xe,e as B,f as o,g as w,w as $,d as m,t as D,u as k,C as p,b as _,c as d,aV as Ce,H as we,a1 as he,l as Ve,F as De,a4 as K,n as ue,$ as ie,a3 as Me}from"./index-a6920b9f.js";import{_ as Ee}from"./ViewBreadcrumbs-ab05e0c8.js";import{_ as ze}from"./MultipleAvatar-3dcbfb2e.js";import{_ as $e}from"./CustomActions-faabd076.js";import{E as Re}from"./EmailAtIcon-944e798e.js";import{P as Ue}from"./PhoneIcon-687b9433.js";import{_ as Le,N as re}from"./NoteModal-52dadb54.js";import{T as de}from"./TaskIcon-4d1dfaf1.js";import{C as Se}from"./CommentIcon-1ba1196a.js";import{I as ee}from"./IndicatorIcon-2f30d1a9.js";import{D as Te}from"./DealsIcon-97fb4069.js";import{L as Ae}from"./LayoutHeader-0ab09138.js";import{_ as Ie}from"./DealsListView-333f8d77.js";import{_ as Pe}from"./KanbanView-1ae38330.js";import{E as Oe}from"./EditIcon-127a74cc.js";import{F as je}from"./FieldLayout-baadb8ff.js";import{s as me}from"./statuses-57fa655e.js";import{i as Be,c as qe}from"./DragVerticalIcon-3e35903f.js";import{u as Qe,c as Ke,q as He}from"./modals-47f1cf8a.js";import{e as ce,b as We,f as H,w as Ge,t as te,d as Je,a as W,D as Ye}from"./index-8df5241e.js";import{T as Xe}from"./TaskModal-03a6c87c.js";import{_ as Ze}from"./ViewControls-f8081380.js";import{g as Fe}from"./global-0d0156ec.js";import{o as Ne}from"./organizations-9b5e5f55.js";import"./Icon-f8d63d14.js";import"./ArrowUpRightIcon-992c4380.js";import"./TextEditor.vue_vue_type_script_setup_true_lang-0d82d5b6.js";import"./helpCenter-a7e44f6b.js";import"./ListBulkActions-aeb61c26.js";import"./DeleteLinkedDocModal-58bed83f.js";import"./ListView-3ebdc383.js";import"./Link-a0855a11.js";import"./ListFooter-0e14e4e1.js";import"./TabButtons-4a3dac25.js";import"./description-f82bb340.js";import"./FadedScrollableDiv-6f6cd639.js";import"./RefreshIcon-37e5629c.js";import"./IconPicker-929f64f0.js";import"./PinIcon-d8be119e.js";import"./DateRangePicker.vue_vue_type_script_setup_true_lang-336ff20f.js";import"./DetailsIcon-18759e5d.js";import"./settings-97110a1e.js";import"./pageMeta-16e1c7dd.js";const et={class:"bg-surface-modal px-4 pb-6 pt-5 sm:px-6"},tt={class:"mb-5 flex items-center justify-between"},at={class:"text-2xl font-semibold leading-6 text-ink-gray-9"},st={class:"flex items-center gap-1"},ot={key:0,class:"mb-4 grid grid-cols-1 gap-4 sm:grid-cols-3"},lt={key:0,class:"flex items-center gap-3 text-sm text-ink-gray-5"},nt={key:1,class:"flex items-center gap-3 text-sm text-ink-gray-5"},ut={key:1,class:"h-px w-full border-t my-5"},it={class:"px-4 pb-7 pt-4 sm:px-6"},rt={class:"flex flex-row-reverse gap-2"},dt={__name:"DealModal",props:ge({defaults:Object},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(G){const J=G,{getUser:Y,isManager:X}=_e(),{getDealStatus:Z,statusOptions:I}=me(),S=be(G,"modelValue"),q=ye(),g=f(null),{document:n,triggerOnBeforeCreate:z}=Qe("CRM Deal"),R=f(!0),u=f(!0),U=f(!1),L=f(!1),T=f(!1),M=f(null);ke([T,L],([c,C])=>{s.data.forEach(E=>{E.sections.forEach(b=>{b.name==="organization_section"?b.hidden=!c:b.name==="organization_details_section"?b.hidden=c:b.name==="contact_section"?b.hidden=!C:b.name==="contact_details_section"&&(b.hidden=C)})})});const s=ne({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout",cache:["QuickEntry","CRM Deal"],params:{doctype:"CRM Deal",type:"Quick Entry"},auto:!0,transform:c=>(R.value=!1,c.forEach(C=>{C.sections.forEach(E=>{E.columns.forEach(b=>{["organization_section","organization_details_section"].includes(E.name)?R.value=!0:["contact_section","contact_details_section"].includes(E.name)&&(u.value=!0),b.fields.forEach(h=>{h.fieldname=="status"&&(h.fieldtype="Select",h.options=A.value,h.prefix=Z(n.doc.status).color),h.fieldtype==="Table"&&(n.doc[h.fieldname]=[])})})})}))}),A=pe(()=>{let c=I("deal");return n.doc.status||(n.doc.status=c[0].value),c});async function F(){n.doc.website&&!n.doc.website.startsWith("http")&&(n.doc.website="https://"+n.doc.website),L.value?(n.doc.first_name=null,n.doc.last_name=null,n.doc.email=null,n.doc.mobile_no=null):n.doc.contact=null,await(z==null?void 0:z()),ne({url:"crm.fcrm.doctype.crm_deal.crm_deal.create_deal",params:{args:n.doc},auto:!0,validate(){if(g.value=null,n.doc.annual_revenue){if(typeof n.doc.annual_revenue=="string")n.doc.annual_revenue=n.doc.annual_revenue.replace(/,/g,"");else if(isNaN(n.doc.annual_revenue))return g.value=__("Annual Revenue should be a number"),g.value}if(n.doc.mobile_no&&isNaN(n.doc.mobile_no.replace(/[-+() ]/g,"")))return g.value=__("Mobile No should be a number"),g.value;if(n.doc.email&&!n.doc.email.includes("@"))return g.value=__("Invalid Email"),g.value;if(!n.doc.status)return g.value=__("Status is required"),g.value;U.value=!0},onSuccess(c){Ce("deal_created"),U.value=!1,S.value=!1,q.push({name:"Deal",params:{dealId:c}})},onError(c){if(U.value=!1,!c.messages){g.value=c.message;return}g.value=c.messages.join(`
`)}})}function N(){Ke.value=!0,He.value={doctype:"CRM Deal"},we(()=>S.value=!1)}return xe(()=>{n.doc={no_of_employees:"1-10"},Object.assign(n.doc,J.defaults),n.doc.deal_owner||(n.doc.deal_owner=Y().name),!n.doc.status&&A.value[0].value&&(n.doc.status=A.value[0].value)}),(c,C)=>{const E=B("Button"),b=B("ErrorMessage"),h=B("Dialog");return o(),w(h,{modelValue:S.value,"onUpdate:modelValue":C[3]||(C[3]=P=>S.value=P),options:{size:"3xl"}},{body:$(()=>{var P;return[m("div",et,[m("div",tt,[m("div",null,[m("h3",at,D(c.__("Create Deal")),1)]),m("div",st,[k(X)()&&!k(Be)?(o(),w(E,{key:0,variant:"ghost",class:"w-7",tooltip:c.__("Edit fields layout"),icon:Oe,onClick:N},null,8,["tooltip"])):p("",!0),_(E,{variant:"ghost",class:"w-7",icon:"x",onClick:C[0]||(C[0]=O=>S.value=!1)})])]),m("div",null,[R.value||u.value?(o(),d("div",ot,[R.value?(o(),d("div",lt,[m("div",null,D(c.__("Choose Existing Organization")),1),_(k(ce),{modelValue:T.value,"onUpdate:modelValue":C[1]||(C[1]=O=>T.value=O)},null,8,["modelValue"])])):p("",!0),u.value?(o(),d("div",nt,[m("div",null,D(c.__("Choose Existing Contact")),1),_(k(ce),{modelValue:L.value,"onUpdate:modelValue":C[2]||(C[2]=O=>L.value=O)},null,8,["modelValue"])])):p("",!0)])):p("",!0),R.value||u.value?(o(),d("div",ut)):p("",!0),(P=k(s).data)!=null&&P.length?(o(),w(je,{key:2,ref_key:"fieldLayoutRef",ref:M,tabs:k(s).data,data:k(n).doc,doctype:"CRM Deal"},null,8,["tabs","data"])):p("",!0),g.value?(o(),w(b,{key:3,class:"mt-4",message:c.__(g.value)},null,8,["message"])):p("",!0)])]),m("div",it,[m("div",rt,[_(E,{variant:"solid",label:c.__("Create"),loading:U.value,onClick:F},null,8,["label","loading"])])])]}),_:1},8,["modelValue"])}}},ct={class:"flex gap-2 items-center"},_t={key:0},pt={key:1},mt={key:2},ft={key:3,class:"truncate text-base"},vt={key:4,class:"truncate text-base"},gt={key:5,class:"truncate text-base"},bt={key:6,class:"text-ink-gray-4"},yt={key:0,class:"truncate flex items-center gap-2"},kt={key:0},xt={key:1},Ct={key:2},wt={key:3,class:"truncate text-base"},ht={key:4,class:"truncate text-base"},Vt={key:5,class:"flex items-center"},Dt={key:6,class:"truncate text-base"},Mt={class:"flex gap-2 items-center justify-between"},Et={class:"text-ink-gray-5 flex items-center gap-1.5"},zt={key:0},$t={key:1},Rt={key:2},Ut={key:3},Lt={key:2,class:"flex h-full items-center justify-center"},St={class:"flex flex-col items-center gap-3 text-xl font-medium text-ink-gray-4"},ha={__name:"Deals",setup(G){const{getFormattedPercent:J,getFormattedFloat:Y,getFormattedCurrency:X}=We("CRM Deal"),{makeCall:Z}=Fe(),{getUser:I}=_e(),{getOrganization:S}=Ne(),{getDealStatus:q}=me(),g=he(),n=f(null),z=f(!1),R=Ve({}),u=f({}),U=f(1),L=f(1),T=f(20),M=f(null);function s(i,t){var v;function y(e){return e&&typeof e=="object"&&!Array.isArray(e)?e:{label:e}}return y((v=A.value)==null?void 0:v.find(e=>e.name==i)[t])}const A=pe(()=>{var i,t,y,v,e,a,r;return(t=(i=u.value)==null?void 0:i.data)!=null&&t.data?u.value.data.view_type==="group_by"?(v=(y=u.value)==null?void 0:y.data.group_by_field)!=null&&v.fieldname?F((e=u.value)==null?void 0:e.data.data,(a=u.value)==null?void 0:a.data.group_by_field,u.value.data.columns):[]:u.value.data.view_type==="kanban"?N(u.value.data.data,u.value.data.fields):c((r=u.value)==null?void 0:r.data.data,u.value.data.columns):[]});function F(i,t,y){var e;let v=[];return(e=t.options)==null||e.forEach(a=>{let r=[];a?r=i.filter(x=>x[t.fieldname]==a):r=i.filter(x=>!x[t.fieldname]);let l={label:t.label,group:a||__(" "),collapsed:!1,rows:c(r,y)};t.fieldname=="status"&&(l.icon=()=>{var x;return K(ee,{class:(x=q(a))==null?void 0:x.color})}),v.push(l)}),v||i}function N(i,t){let y=[];return i.forEach(v=>{var e;(e=v.data)==null||e.forEach(a=>{y.push(a)})}),c(y,t)}function c(i,t=[]){let y=u.value.data.view_type,v=y==="kanban"?"fieldname":"key",e=y==="kanban"?"fieldtype":"type";return i.map(a=>{let r={};return u.value.data.rows.forEach(l=>{var ae,se,oe;r[l]=a[l];let x=(ae=t==null?void 0:t.find(V=>(V[v]||V.value)==l))==null?void 0:ae[e];if(x&&["Date","Datetime"].includes(x)&&!["modified","creation"].includes(l)&&(r[l]=H(a[l],"",!0,x=="Datetime")),x&&x=="Currency"&&(r[l]=X(l,a)),x&&x=="Float"&&(r[l]=Y(l,a)),x&&x=="Percent"&&(r[l]=J(l,a)),l=="organization")r[l]={label:a.organization,logo:(se=S(a.organization))==null?void 0:se.organization_logo};else if(l==="website")r[l]=Ge(a.website);else if(l=="status")r[l]={label:a.status,color:(oe=q(a.status))==null?void 0:oe.color};else if(l=="sla_status"){let V=a.sla_status,j=V,le=a.sla_status=="Failed"?"red":a.sla_status=="Fulfilled"?"green":"orange";(V=="First Response Due"||V=="Rolling Response Due")&&(V=__(te(a.response_by)),j=H(a.response_by),new Date(a.response_by)<new Date&&(le="red")),r[l]={label:j,value:V,color:le}}else if(l=="deal_owner")r[l]={label:a.deal_owner&&I(a.deal_owner).full_name,...a.deal_owner&&I(a.deal_owner)};else if(l=="_assign"){let V=JSON.parse(a._assign||"[]");r[l]=V.map(j=>({name:j,image:I(j).user_image,label:I(j).full_name}))}else if(["modified","creation"].includes(l))r[l]={label:H(a[l]),timeAgo:__(te(a[l]))};else if(["first_response_time","first_responded_on","response_by"].includes(l)){let V=l=="response_by"?"response_by":"first_responded_on";r[l]={label:a[V]?H(a[V]):"",timeAgo:a[l]?l=="first_response_time"?Je(a[l]):__(te(a[l])):""}}}),r._email_count=a._email_count,r._note_count=a._note_count,r._task_count=a._task_count,r._comment_count=a._comment_count,r})}function C(i){let t=u.value.params.column_field;t&&(R[t]=i.column.name),z.value=!0}function E(i){var v;let t=((v=s(i,"mobile_no"))==null?void 0:v.label)||"";return[{icon:K(Ue,{class:"h-4 w-4"}),label:__("Make a Call"),onClick:()=>Z(t),condition:()=>t&&qe.value},{icon:K(re,{class:"h-4 w-4"}),label:__("New Note"),onClick:()=>O(i)},{icon:K(de,{class:"h-4 w-4"}),label:__("New Task"),onClick:()=>ve(i)}].filter(e=>e.condition?e.condition():!0)}const b=f(""),h=f(!1),P=f({title:"",content:""});function O(i){b.value=i,h.value=!0}const Q=f(!1),fe=f({title:"",description:"",assigned_to:"",due_date:"",priority:"Low",status:"Backlog"});function ve(i){b.value=i,Q.value=!0}return(i,t)=>{const y=B("Button"),v=B("Badge");return o(),d(De,null,[_(Ae,null,{"left-header":$(()=>[_(Ee,{modelValue:M.value,"onUpdate:modelValue":t[0]||(t[0]=e=>M.value=e),routeName:"Deals"},null,8,["modelValue"])]),"right-header":$(()=>{var e;return[(e=n.value)!=null&&e.customListActions?(o(),w($e,{key:0,actions:n.value.customListActions},null,8,["actions"])):p("",!0),_(y,{variant:"solid",label:i.__("Create"),iconLeft:"plus",onClick:t[1]||(t[1]=a=>z.value=!0)},null,8,["label"])]}),_:1}),_(Ze,{ref_key:"viewControls",ref:M,modelValue:u.value,"onUpdate:modelValue":t[2]||(t[2]=e=>u.value=e),loadMore:U.value,"onUpdate:loadMore":t[3]||(t[3]=e=>U.value=e),resizeColumn:L.value,"onUpdate:resizeColumn":t[4]||(t[4]=e=>L.value=e),updatedPageCount:T.value,"onUpdate:updatedPageCount":t[5]||(t[5]=e=>T.value=e),doctype:"CRM Deal",options:{allowedViews:["list","group_by","kanban"]}},null,8,["modelValue","loadMore","resizeColumn","updatedPageCount"]),k(g).params.viewType=="kanban"?(o(),w(Pe,{key:0,modelValue:u.value,"onUpdate:modelValue":t[7]||(t[7]=e=>u.value=e),options:{getRoute:e=>({name:"Deal",params:{dealId:e.name},query:{view:k(g).query.view,viewType:k(g).params.viewType}}),onNewClick:e=>C(e)},onUpdate:t[8]||(t[8]=e=>M.value.updateKanbanSettings(e)),onLoadMore:t[9]||(t[9]=e=>M.value.loadMoreKanban(e))},{title:$(({titleField:e,itemName:a})=>[m("div",ct,[e==="status"?(o(),d("div",_t,[_(ee,{class:ue(s(a,e).color)},null,8,["class"])])):e==="organization"&&s(a,e).label?(o(),d("div",pt,[_(k(W),{class:"flex items-center",image:s(a,e).logo,label:s(a,e).label,size:"sm"},null,8,["image","label"])])):e==="deal_owner"&&s(a,e).full_name?(o(),d("div",mt,[_(k(W),{class:"flex items-center",image:s(a,e).user_image,label:s(a,e).full_name,size:"sm"},null,8,["image","label"])])):p("",!0),["modified","creation","first_response_time","first_responded_on","response_by"].includes(e)?(o(),d("div",ft,[_(k(ie),{text:s(a,e).label},{default:$(()=>[m("div",null,D(s(a,e).timeAgo),1)]),_:2},1032,["text"])])):e==="sla_status"?(o(),d("div",vt,[s(a,e).value?(o(),w(v,{key:0,variant:"subtle",theme:s(a,e).color,size:"md",label:s(a,e).value},null,8,["theme","label"])):p("",!0)])):s(a,e).label?(o(),d("div",gt,D(s(a,e).label),1)):(o(),d("div",bt,D(i.__("No Title")),1))])]),fields:$(({fieldName:e,itemName:a})=>[s(a,e).label?(o(),d("div",yt,[e==="status"?(o(),d("div",kt,[_(ee,{class:ue(s(a,e).color)},null,8,["class"])])):e==="organization"?(o(),d("div",xt,[s(a,e).label?(o(),w(k(W),{key:0,class:"flex items-center",image:s(a,e).logo,label:s(a,e).label,size:"xs"},null,8,["image","label"])):p("",!0)])):e==="deal_owner"?(o(),d("div",Ct,[s(a,e).full_name?(o(),w(k(W),{key:0,class:"flex items-center",image:s(a,e).user_image,label:s(a,e).full_name,size:"xs"},null,8,["image","label"])):p("",!0)])):p("",!0),["modified","creation","first_response_time","first_responded_on","response_by"].includes(e)?(o(),d("div",wt,[_(k(ie),{text:s(a,e).label},{default:$(()=>[m("div",null,D(s(a,e).timeAgo),1)]),_:2},1032,["text"])])):e==="sla_status"?(o(),d("div",ht,[s(a,e).value?(o(),w(v,{key:0,variant:"subtle",theme:s(a,e).color,size:"md",label:s(a,e).value},null,8,["theme","label"])):p("",!0)])):e==="_assign"?(o(),d("div",Vt,[_(ze,{avatars:s(a,e).label,size:"xs"},null,8,["avatars"])])):(o(),d("div",Dt,D(s(a,e).label),1))])):p("",!0)]),actions:$(({itemName:e})=>[m("div",Mt,[m("div",Et,[_(Re,{class:"h-4 w-4"}),s(e,"_email_count").label?(o(),d("span",zt,D(s(e,"_email_count").label),1)):p("",!0),t[23]||(t[23]=m("span",{class:"text-3xl leading-[0]"}," · ",-1)),_(re,{class:"h-4 w-4"}),s(e,"_note_count").label?(o(),d("span",$t,D(s(e,"_note_count").label),1)):p("",!0),t[24]||(t[24]=m("span",{class:"text-3xl leading-[0]"}," · ",-1)),_(de,{class:"h-4 w-4"}),s(e,"_task_count").label?(o(),d("span",Rt,D(s(e,"_task_count").label),1)):p("",!0),t[25]||(t[25]=m("span",{class:"text-3xl leading-[0]"}," · ",-1)),_(Se,{class:"h-4 w-4"}),s(e,"_comment_count").label?(o(),d("span",Ut,D(s(e,"_comment_count").label),1)):p("",!0)]),_(k(Ye),{class:"flex items-center gap-2",options:E(e),variant:"ghost",onClick:t[6]||(t[6]=Me(()=>{},["stop","prevent"]))},{default:$(()=>[_(y,{icon:"plus",variant:"ghost"})]),_:1},8,["options"])])]),_:1},8,["modelValue","options"])):u.value.data&&A.value.length?(o(),w(Ie,{key:1,ref_key:"dealsListView",ref:n,modelValue:u.value.data.page_length_count,"onUpdate:modelValue":t[10]||(t[10]=e=>u.value.data.page_length_count=e),list:u.value,"onUpdate:list":t[11]||(t[11]=e=>u.value=e),rows:A.value,columns:u.value.data.columns,options:{showTooltip:!1,resizeColumn:!0,rowCount:u.value.data.row_count,totalCount:u.value.data.total_count},onLoadMore:t[12]||(t[12]=()=>U.value++),onColumnWidthUpdated:t[13]||(t[13]=()=>L.value++),onUpdatePageCount:t[14]||(t[14]=e=>T.value=e),onApplyFilter:t[15]||(t[15]=e=>M.value.applyFilter(e)),onApplyLikeFilter:t[16]||(t[16]=e=>M.value.applyLikeFilter(e)),onLikeDoc:t[17]||(t[17]=e=>M.value.likeDoc(e)),onSelectionsChanged:t[18]||(t[18]=e=>M.value.updateSelections(e))},null,8,["modelValue","list","rows","columns","options"])):u.value.data?(o(),d("div",Lt,[m("div",St,[_(Te,{class:"h-10 w-10"}),m("span",null,D(i.__("No {0} Found",[i.__("Deals")])),1),_(y,{label:i.__("Create"),iconLeft:"plus",onClick:t[19]||(t[19]=e=>z.value=!0)},null,8,["label"])])])):p("",!0),z.value?(o(),w(dt,{key:3,modelValue:z.value,"onUpdate:modelValue":t[20]||(t[20]=e=>z.value=e),defaults:R},null,8,["modelValue","defaults"])):p("",!0),h.value?(o(),w(Le,{key:4,modelValue:h.value,"onUpdate:modelValue":t[21]||(t[21]=e=>h.value=e),note:P.value,doctype:"CRM Deal",doc:b.value},null,8,["modelValue","note","doc"])):p("",!0),Q.value?(o(),w(Xe,{key:5,modelValue:Q.value,"onUpdate:modelValue":t[22]||(t[22]=e=>Q.value=e),task:fe.value,doctype:"CRM Deal",doc:b.value},null,8,["modelValue","task","doc"])):p("",!0)],64)}}};export{ha as default};
//# sourceMappingURL=Deals-2ea94fbd.js.map
