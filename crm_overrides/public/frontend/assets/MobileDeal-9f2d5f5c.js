import{a as Me}from"./DeleteLinkedDocModal-58bed83f.js";import{_ as Se}from"./ErrorPage-f1ea6704.js";import{_ as Re}from"./Icon-f8d63d14.js";import{D as ne}from"./DetailsIcon-18759e5d.js";import{A as $e,a as Ee,u as Te,b as Le,S as ze,L as Pe,c as Oe}from"./useActiveTabManager-ba8c3899.js";import{E as Ue}from"./EmailMultiSelect-9a571b70.js";import{E as Be}from"./Email2Icon-e5467a9c.js";import{C as Ne}from"./CommentIcon-1ba1196a.js";import{P as le}from"./PhoneIcon-687b9433.js";import{T as Fe}from"./TaskIcon-4d1dfaf1.js";import{N as qe}from"./NoteModal-52dadb54.js";import{W as je}from"./WhatsAppIcon-bde39cdc.js";import{I as We}from"./IndicatorIcon-2f30d1a9.js";import{A as He}from"./ArrowUpRightIcon-992c4380.js";import{g as Ke,S as Ye,a as Ge}from"./view-d56bbd34.js";import{L as Je}from"./LayoutHeader-0ab09138.js";import{_ as Qe}from"./OrganizationModal-84210b64.js";import{_ as Xe}from"./LostReasonModal-7c0e4bdf.js";import{C as Ze}from"./ContactModal-0482c4e7.js";import{u as ea,d as aa,e as ta,b as oa,_ as sa}from"./modals-47f1cf8a.js";import{L as na}from"./Link-a0855a11.js";import{_ as re}from"./CustomActions-faabd076.js";import{b as la,s as ra,D as ie,a as ia}from"./index-8df5241e.js";import{g as ca}from"./settings-97110a1e.js";import{g as ua}from"./global-0d0156ec.js";import{s as da}from"./statuses-57fa655e.js";import{i as ma,c as pa,w as _a}from"./DragVerticalIcon-3e35903f.js";import{a1 as fa,aM as va,m as y,z as L,A as ce,Y as ue,c as _,b as l,w as m,u as t,d as f,g as p,C as u,aK as de,F as me,aT as b,aS as z,e as W,f as o,n as H,t as A,r as ya,aD as pe,a4 as ga}from"./index-a6920b9f.js";import{_ as ha}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-7d13eeef.js";import{u as ba}from"./pageMeta-16e1c7dd.js";import"./ListView-3ebdc383.js";import"./CalendarIcon-28657f45.js";import"./CallLogModal-50e95440.js";import"./EditIcon-127a74cc.js";import"./ContactsIcon-e88572ff.js";import"./LeadsIcon-fdfd4494.js";import"./DealsIcon-97fb4069.js";import"./TaskModal-03a6c87c.js";import"./TextEditor.vue_vue_type_script_setup_true_lang-0d82d5b6.js";import"./helpCenter-a7e44f6b.js";import"./FadedScrollableDiv-6f6cd639.js";import"./FieldLayout-baadb8ff.js";import"./MultipleAvatar-3dcbfb2e.js";import"./event-2ffbd56c.js";import"./ComboboxViewport-5c5445f5.js";import"./IconPicker-929f64f0.js";import"./FileUploader-28868f3a.js";const Ca={class:"relative flex h-10.5 items-center justify-between gap-2 py-2.5 pl-2"},ka={class:"absolute right-0"},wa={key:0,class:"flex h-12 items-center justify-between gap-2 border-b px-3 py-2.5"},xa={class:"flex items-center gap-2"},Ia={key:1,class:"flex h-full overflow-hidden"},Da={key:0},Va={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},Aa={key:0,class:"pr-2"},Ma={key:0,class:"contacts-area"},Sa={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-ink-gray-4"},Ra={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-ink-gray-7"},$a=["onClick"],Ea={class:"truncate"},Ta={class:"flex items-center"},La={class:"flex flex-col gap-1.5 text-base text-ink-gray-8"},za={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Pa={class:"flex items-center gap-3 p-1 py-1.5"},Oa={key:0,class:"mx-2 h-px border-t border-outline-gray-modals"},Ua={key:2,class:"flex h-20 items-center justify-center text-base text-ink-gray-5"},Et={__name:"MobileDeal",props:{dealId:{type:String,required:!0}},setup(I){const{brand:_e}=ca(),{$dialog:fe,$socket:ve}=ua(),{statusOptions:ye,getDealStatus:P}=da(),{doctypeMeta:ge}=la("CRM Deal"),C=fa(),O=va(),g=I,M=y(""),U=y(""),S=y(!1),{triggerOnChange:he,assignees:B,document:d,scripts:K,error:be}=ea("CRM Deal",g.dealId),n=L(()=>d.doc||{});ce(be,e=>{var a;e?(M.value=__(e.exc_type=="DoesNotExistError"?"Document not found":"Error occurred"),U.value=__(((a=e.messages)==null?void 0:a[0])||"An error occurred")):(M.value="",U.value="")}),ce(()=>d.doc,async e=>{var a;if((a=K.data)!=null&&a.length){let s=await ra(K.data,{doc:e,$dialog:fe,$socket:ve,router:O,toast:b,updateField:q,createToast:b.create,deleteDoc:De,call:z});d._actions=s.actions||[],d._statuses=s.statuses||[]}},{once:!0});const N=y(!1),R=y(!1),Y=y({}),Ce=L(()=>{let e=[{label:__("Deals"),route:{name:"Deals"}}];if(C.query.view||C.query.viewType){let a=Ke(C.query.view,C.query.viewType,"CRM Deal");a&&e.push({label:__(a.label),icon:a.icon,route:{name:"Deals",params:{viewType:C.query.viewType},query:{view:C.query.view}}})}return e.push({label:G.value,route:{name:"Deal",params:{dealId:g.dealId}}}),e}),G=L(()=>{var a,s;let e=((a=ge["CRM Deal"])==null?void 0:a.title_field)||"name";return((s=n.value)==null?void 0:s[e])||g.dealId});ba(()=>({title:G.value,icon:_e.favicon}));const F=L(()=>[{name:"Details",label:__("Details"),icon:ne,condition:()=>ma.value},{name:"Activity",label:__("Activity"),icon:$e},{name:"Emails",label:__("Emails"),icon:Ue},{name:"Comments",label:__("Comments"),icon:Ne},{name:"Data",label:__("Data"),icon:ne},{name:"Calls",label:__("Calls"),icon:le,condition:()=>pa.value},{name:"Tasks",label:__("Tasks"),icon:Fe},{name:"Notes",label:__("Notes"),icon:qe},{name:"Attachments",label:__("Attachments"),icon:Ee},{name:"WhatsApp",label:__("WhatsApp"),icon:je,condition:()=>_a.value}].filter(a=>a.condition?a.condition():!0)),{tabIndex:k}=Te(F,"lastDealTab"),$=ue({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_sidepanel_sections",cache:["sidePanelSections","CRM Deal"],params:{doctype:"CRM Deal"},auto:!0,transform:e=>ke(e)});function ke(e){return e.forEach(a=>{a.name!="contacts_section"&&a.columns[0].fields.forEach(s=>{s.name=="organization"&&(s.create=(r,x)=>{Y.value.organization_name=r,R.value=!0,x()},s.link=r=>O.push({name:"Organization",params:{organizationId:r}}))})}),e}const E=y(!1),J=y({});function we(e){let a=[{label:__("Delete"),icon:"trash-2",onClick:()=>xe(e)}];return e.is_primary||a.push({label:__("Set as Primary Contact"),icon:ga(Ge,{class:"h-4 w-4"}),onClick:()=>Ie(e.name)}),a}async function Q(e){var s;if((s=w.data)!=null&&s.find(r=>r.name===e)){b.error(__("Contact already added"));return}await z("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:g.dealId,contact:e})&&(w.reload(),b.success(__("Contact added")))}async function xe(e){await z("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:g.dealId,contact:e})&&(w.reload(),b.success(__("Contact removed")))}async function Ie(e){await z("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:g.dealId,contact:e})&&(w.reload(),b.success(__("Primary contact set")))}const w=ue({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:g.dealId},cache:["deal_contacts",g.dealId],auto:!0,onSuccess:e=>{var s;let a=(s=$.data)==null?void 0:s.find(r=>r.name=="contacts_section");a&&(a.contacts=e.map(r=>({name:r.name,full_name:r.full_name,email:r.email,mobile_no:r.mobile_no,image:r.image,is_primary:r.is_primary,opened:!1})))}});function q(e,a){a=Array.isArray(e)?"":a;let s=Array.isArray(e)?{}:n.value[e];Array.isArray(e)?e.forEach(r=>n.value[r]=a):n.value[e]=a,d.save.submit(null,{onSuccess:()=>N.value=!0,onError:r=>{var x;Array.isArray(e)?e.forEach(D=>n.value[D]=s[D]):n.value[e]=s,b.error(((x=r.messages)==null?void 0:x[0])||__("Error updating field"))}})}function De(){S.value=!0}async function Ve(e){await he("status",e),X()}const T=y(!1);function X(){if(P(n.status).type!=="Lost"||n.lost_reason&&n.lost_reason!=="Other"||n.lost_reason==="Other"&&n.lost_notes){d.save.submit();return}T.value=!0}function Z(e){e!=null&&e.hasOwnProperty("status")&&P(e.status).type=="Lost"?X():d.save.submit(null,{onSuccess:()=>j(e)})}function j(e){e!=null&&e.hasOwnProperty("deal_owner")&&B.reload()}return(e,a)=>{var D,ee;const s=W("Button"),r=W("Badge"),x=W("FeatherIcon");return o(),_(me,null,[l(Je,null,{default:m(()=>{var i;return[f("header",Ca,[l(t(ha),{items:Ce.value},{prefix:m(({item:c})=>[c.icon?(o(),p(Re,{key:0,icon:c.icon,class:"mr-2 h-4"},null,8,["icon"])):u("",!0)]),_:1},8,["items"]),f("div",ka,[n.value?(o(),p(t(ie),{key:0,options:t(ye)("deal",(i=t(d).statuses)!=null&&i.length?t(d).statuses:t(d)._statuses,Ve)},{default:m(({open:c})=>[n.value.status?(o(),p(s,{key:0,label:n.value.status,iconRight:c?"chevron-up":"chevron-down"},{prefix:m(()=>[l(We,{class:H(t(P)(n.value.status).color)},null,8,["class"])]),_:1},8,["label","iconRight"])):u("",!0)]),_:1},8,["options"])):u("",!0)])])]}),_:1}),n.value.name?(o(),_("div",wa,[l(Le,{modelValue:t(B).data,"onUpdate:modelValue":a[0]||(a[0]=i=>t(B).data=i),doctype:"CRM Deal",docname:I.dealId},null,8,["modelValue","docname"]),f("div",xa,[(D=t(d)._actions)!=null&&D.length?(o(),p(re,{key:0,actions:t(d)._actions},null,8,["actions"])):u("",!0),(ee=t(d).actions)!=null&&ee.length?(o(),p(re,{key:1,actions:t(d).actions},null,8,["actions"])):u("",!0)])])):u("",!0),n.value.name?(o(),_("div",Ia,[l(t(sa),{as:"div",modelValue:t(k),"onUpdate:modelValue":a[5]||(a[5]=i=>de(k)?k.value=i:null),tabs:F.value,class:"overflow-auto"},{default:m(()=>[l(t(aa),{class:"!px-3"}),l(t(ta),null,{default:m(({tab:i})=>[i.name=="Details"?(o(),_("div",Da,[n.value.sla_status?(o(),p(ze,{key:0,modelValue:n.value,"onUpdate:modelValue":a[1]||(a[1]=c=>n.value=c),onUpdateField:q},null,8,["modelValue"])):u("",!0),t($).data?(o(),_("div",Va,[l(Ye,{sections:t($).data,doctype:"CRM Deal",docname:I.dealId,onReload:t($).reload,onBeforeFieldChange:Z,onAfterFieldChange:j},{actions:m(({section:c})=>[c.name=="contacts_section"?(o(),_("div",Aa,[l(na,{value:"",doctype:"Contact",onChange:a[2]||(a[2]=h=>Q(h)),onCreate:(h,V)=>{J.value={first_name:h,company_name:n.value.organization},E.value=!0,V()}},{target:m(({togglePopover:h})=>[l(s,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:V=>h()},null,8,["onClick"])]),_:1},8,["onCreate"])])):u("",!0)]),default:m(({section:c})=>{var h,V,ae;return[c.name=="contacts_section"?(o(),_("div",Ma,[(h=t(w))!=null&&h.loading&&((ae=(V=t(w))==null?void 0:V.data)==null?void 0:ae.length)==0?(o(),_("div",Sa,[l(Pe,{class:"h-4 w-4"}),f("span",null,A(e.__("Loading...")),1)])):c.contacts.length?(o(!0),_(me,{key:1},ya(c.contacts,(v,te)=>(o(),_("div",{key:v.name},[f("div",{class:H(["px-2 pb-2.5",[te==0?"pt-5":"pt-2.5"]])},[l(oa,{opened:v.opened},{header:m(({opened:Ae,toggle:oe})=>[f("div",Ra,[f("div",{class:"flex h-7 items-center gap-2 truncate",onClick:se=>oe()},[l(t(ia),{label:v.full_name,image:v.image,size:"md"},null,8,["label","image"]),f("div",Ea,A(v.full_name),1),v.is_primary?(o(),p(r,{key:0,class:"ml-2",variant:"outline",label:e.__("Primary"),theme:"green"},null,8,["label"])):u("",!0)],8,$a),f("div",Ta,[l(t(ie),{options:we(v.name)},{default:m(()=>[l(s,{icon:"more-horizontal",class:"text-ink-gray-5",variant:"ghost"})]),_:1},8,["options"]),l(s,{variant:"ghost",onClick:se=>t(O).push({name:"Contact",params:{contactId:v.name}})},{default:m(()=>[l(He,{class:"h-4 w-4"})]),_:1},8,["onClick"]),l(s,{variant:"ghost",onClick:se=>oe()},{default:m(()=>[l(x,{name:"chevron-right",class:H(["h-4 w-4 text-ink-gray-9 transition-all duration-300 ease-in-out",{"rotate-90":Ae}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:m(()=>[f("div",La,[f("div",za,[l(Be,{class:"h-4 w-4"}),pe(" "+A(v.email),1)]),f("div",Pa,[l(le,{class:"h-4 w-4"}),pe(" "+A(v.mobile_no),1)])])]),_:2},1032,["opened"])],2),te!=c.contacts.length-1?(o(),_("div",Oa)):u("",!0)]))),128)):(o(),_("div",Ua,A(e.__("No contacts added")),1))])):u("",!0)]}),_:1},8,["sections","docname","onReload"])])):u("",!0)])):(o(),p(Oe,{key:1,doctype:"CRM Deal",docname:I.dealId,tabs:F.value,reload:N.value,"onUpdate:reload":a[3]||(a[3]=c=>N.value=c),tabIndex:t(k),"onUpdate:tabIndex":a[4]||(a[4]=c=>de(k)?k.value=c:null),onBeforeSave:Z,onAfterSave:j},null,8,["docname","tabs","reload","tabIndex"]))]),_:1})]),_:1},8,["modelValue","tabs"])])):M.value?(o(),p(Se,{key:2,errorTitle:M.value,errorMessage:U.value},null,8,["errorTitle","errorMessage"])):u("",!0),R.value?(o(),p(Qe,{key:3,modelValue:R.value,"onUpdate:modelValue":a[6]||(a[6]=i=>R.value=i),data:Y.value,options:{redirect:!1,afterInsert:i=>q("organization",i.name)}},null,8,["modelValue","data","options"])):u("",!0),E.value?(o(),p(Ze,{key:4,modelValue:E.value,"onUpdate:modelValue":a[7]||(a[7]=i=>E.value=i),contact:J.value,options:{redirect:!1,afterInsert:i=>Q(i.name)}},null,8,["modelValue","contact","options"])):u("",!0),S.value?(o(),p(Me,{key:5,modelValue:S.value,"onUpdate:modelValue":a[8]||(a[8]=i=>S.value=i),doctype:"CRM Deal",docname:I.dealId,name:"Deals"},null,8,["modelValue","docname"])):u("",!0),T.value?(o(),p(Xe,{key:6,modelValue:T.value,"onUpdate:modelValue":a[9]||(a[9]=i=>T.value=i),deal:t(d)},null,8,["modelValue","deal"])):u("",!0)],64)}}};export{Et as default};
//# sourceMappingURL=MobileDeal-9f2d5f5c.js.map
